name: Watch Master Data

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual run

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check External Master Data Version
        id: check
        run: |
          # Fetch the latest commit SHA for the 'master' path in the target repo
          # Use GITHUB_TOKEN to avoid rate limits and generic errors
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/Team-Haruki/haruki-sekai-master/commits?path=master&per_page=1")
          
          # Check if response is valid JSON array
          if ! echo "$RESPONSE" | jq -e '.[0].sha' > /dev/null; then
            echo "Error parsing response from GitHub API:"
            echo "$RESPONSE"
            exit 1
          fi

          LATEST_SHA=$(echo "$RESPONSE" | jq -r '.[0].sha')
          echo "Latest SHA: $LATEST_SHA"
          echo "latest_sha=$LATEST_SHA" >> $GITHUB_OUTPUT

      - name: Compare and Update
        run: |
          LATEST_SHA="${{ steps.check.outputs.latest_sha }}"
          CURRENT_SHA=$(cat data/master_version.txt || echo "none")
          
          if [ "$LATEST_SHA" != "$CURRENT_SHA" ]; then
            echo "New version detected: $LATEST_SHA"
            echo "$LATEST_SHA" > data/master_version.txt
            
            git config --global user.name 'Snowy Bot'
            git config --global user.email 'bot@snowy.viewer'
            git add data/master_version.txt
            git commit -m "chore: update master data version to $LATEST_SHA"
            git push
          else
            echo "No updates found."
          fi
